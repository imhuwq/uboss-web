<%= content_for :extra_meta_tags do %>
  <%= sharing_meta_tags(@product, @sharing_link_node) %>
<% end %>

<%= content_for :extra_javascript do %>
  <% if browser.wechat? %>
    <script type="text/javascript" charset="utf-8">
      wx.ready(function(){ UBoss.luffy.invokeSharing(); });
    </script>
  <% end %>
  <%= javascript_include_tag "mobile_page/jsmvc_app/application" %>
<% end %>

<div class="fixed-container">
  <div class="product-box product-page">
    <div class="cover">
      <div class="img" style="background-image:url('<%=@product.image_url()%>')"></div>
      <%= image_tag("mobile/img.jpg") %>
      <% if current_user && current_user.has_seller_privilege_card?(@seller) %>
        <div class="like-box">
	        <%= link_to "喜欢", switch_favour_product_path(@product),
	          method: 'PATCH', class: "#{user_favour_product_class(@product)} btn btn-like like-product-btn", remote: true %>
        </div>
      <% end %>
    </div>
  </div><!-- product-box -->

  <div class="product-info-box">
    <p class="title"><%=@product.name%></p>
    <p class="price">
      <small>￥</small>
      <%= product_price(@product).join(' - ') %>
    </p>
    <p class="original-price">￥<%= @product.original_price %></p>
    <div class="border-top">
    	<p class="gray-color">
	    <% if @product.transportation_way != 0 %>
	     	 快递：<%= product_traffic(@product) %>
	    <%else%>
	     	 包邮
	    <% end %>　
	    <%= Evaluation.product_good_reputation_rate(@product.id) %> 好评 (<%= Evaluation.product_good_reputation(@product.id) %>人)
	    </p>
  	</div><!-- border-top -->
  	<br />
  	<div class="detail text-left">
  		<%= @product.short_description %>
  	</div><!-- detail -->
  	<br />
  </div><!-- product-info-box -->

  <!-- 自己的友情卡  -->
  <% if self_privilege_card?(@privilege_card) || qr_sharing? %>
  	<div class="product-info-box">
      <br />
      <div class="friend-card">
	      <div class="name">友情价</div>
	      <br />
        <div class="price">
          <%= product_privilege(@product, @privilege_card, :price).join(' - ') %>
        </div>
	      <br/>
	    	<p class="gray-color">帮朋友优惠<%= product_privilege(@product, @privilege_card, :amount).join(' - ') %></p>
        <div class="border-box">
          <% if @privilege_card.present? %>
            <div class="text-center"><a class="btn btn-large btn-longer p-sharing-btn">分享给朋友</a></div>
          <% else %>
            <div class="text-center">
              <%= link_to "领取友情卡", get_product_sharing_path, data: { pid: @product.id, uid: current_user.present? },
                class: "btn btn-large btn-longer show-req-snode-modal"
              %>
              <a class="btn btn-large btn-longer hidden p-sharing-btn">分享给朋友</a>
            </div>
            <div class="pop-friend hidden">
            	<div class="close pop-friend-close">跳过</div>
            	<div id="page1">
            		<%= image_tag("mobile/friend/bg.png",class:'sun-bg') %>
            		<div class="t1 text-icon"><%= image_tag("mobile/friend/t1.png") %></div>
            		<div class="t2 text-icon"><%= image_tag("mobile/friend/t2.png") %></div>
            		<div class="t3 text-icon"><%= image_tag("mobile/friend/t3.png") %></div>
            		<div class="t4 text-icon"><%= image_tag("mobile/friend/box.png") %></div>
            		<div class="input-box">
            			<p><input type="tel"  class="input-block input-radius input-large input-tel-value" placeholder="请输入手机号码"/></p>
            			<p><input type="submit" class="btn btn-block btn-large" value="领取友情卡" /></p>
            			<p class="white-color">友情卡可以帮好友省钱，帮自己赚钱</p>
            		</div>
            		
            		<div class="show-share-btn">
            			<p class="white-color">友情卡已放入 <span id="user-tel" class="red-color"></span></p>
            			<p><span class="btn btn-block btn-large" id="show-next-page">分享友情卡</span></p>
            			<p class="white-color">友情卡可以帮好友省钱，帮自己赚钱</p>
            		</div>
            	</div><!-- page1 -->
            	<div id="page2" style="display:none">
            		<div class="share-guide">
            			<h4 class="white-color">点击右上角，分享给好友 <%= image_tag("mobile/friend/arrow-up.png",width:'20') %></h4>
            			<br />
            			<p><a href="/sign_in" class="btn btn-block btn-large">验证手机　到账提现</a></p>
            			<p class="text-center white-color"><span class="close">去逛逛</span></p>
            		</div>
            	</div>
            </div><!-- pop-friend -->
            <script>
              $('.t1,.t2,.t3,.t4,.input-box,.sun-bg,.show-share-btn').hide();
              $('.pop-friend').removeClass('hidden');
              $('html,body').addClass('lock');
            	window.onload = function(){
            		$('.t4').show().addClass('zoomIn').css('transform-origin','');
            		setTimeout(function(){
            			$('.sun-bg').show().addClass('zoomIn').css('transform-origin','');
            		},600)
            		setTimeout(function(){
            			$('.t3').show().addClass('scalebottomIn').css('transform-origin','');
            		},800)
            		setTimeout(function(){
            			$('.t2').show().addClass('scalebottomIn').css('transform-origin','');
            		},1100)
            		setTimeout(function(){
            			$('.t1').show().addClass('scalebottomIn').css('transform-origin','');
            		},1400)
            		setTimeout(function(){
            			$('.input-box').show().css('transform-origin','');
            		},1600)
            		//动画结束
            		$('.pop-friend input[type="submit"]').on('click',function(){
            			var user_tel= $('.input-tel-value').val();
            			var telReg = !!user_tel.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);
            			if(!telReg){
            				alert("请输入正确的手机号码")
            			}else{
            				$('#user-tel').text(user_tel)
            				$('.input-box').hide()
            				$('.show-share-btn').show()
            			}
            		})
            		$('#show-next-page').on('click',function(){
            			$('#page1').hide()
            			$('#page2').show()
            		})
            		$('.pop-friend .close').on('click',function(){
            			$('.pop-friend').hide();
            			$('html,body').removeClass('lock');
            		})
            	}
            </script>
          <% end %>
        </div><!-- border-box -->
        <br />
        <p class="gray-color">一级 <%= @product.share_amount_lv_1 %>　　二级 <%= @product.share_amount_lv_2 %>　　三级 <%= @product.share_amount_lv_3 %></p>
        <div class="read"><a href="/about"><small>查看说明</small></a></div>
      </div>  <!-- friend-card -->
    </div><!-- product-info-box -->
  <% elsif other_users_privilege_card?(@privilege_card) %>
    <div class="product-info-box">
      <br />
      <div class="friend-card">
        <p class="cover"><%= image_tag @privilege_card.user.avatar_url(:w120) %></p>
        <p class="name"><%= @privilege_card.user.identify %> 分享</p>
        <div class="gray-color">
          每件为你多省<span class="like-color"><%= product_privilege(@product, @privilege_card, :amount).join(' - ') %></span>
        </div>
        <br />
        <div class="border-box">
          <p class="name">友情价</p>
          <div class="price">
            <%= product_privilege(@product, @privilege_card, :price).join(' - ') %>
          </div>
        </div>
        <br />
        <p class="name">关于分享者</p>
        <div class="gray-color">
          共 <%= @sharing_node.user.total_reputations %> 分享
          <span class="like-color"><%= @sharing_node.user.good_reputation_rate %>% 靠谱</span>
        </div>
      </div>  <!-- friend-card -->
      <br />
    </div><!-- product-info-box -->
  <% end %>
  <!-- end 自己的友情卡 -->

  <div class="bg-white gap">
  	<div class="product-store-box">
	    <div class="cover">
	      <%= image_tag @seller.avatar_url(:w120) %>
	    </div>
			<div class="content">
				<%= link_to  store_path(@seller),class:'btn btn-main-border pull-right' do%>
	       	进店逛逛
	      <%end%>
		    <h4 class="name text-cut"><%= @seller.store_name %></h4>
		    <p class="gray-color"><%= number_to_percentage(@seller.good_reputation_rate, precision: 0) %> 好评（<%= @seller.total_reputations %>）</p>		    
	      <p class="gray-color desc text-cut"><%= @seller.store_short_description %></p>
	      
	 		</div><!-- content -->
    </div><!-- product-store-box -->
  </div><!-- bg-white gap -->
	<br />
  <div class="product-info-box">
    <%== @product.content %>
  </div>

  <% if @sharing_node.blank? %>
    <div class="share_buy">
      <% if current_user %>
        <%= link_to '加入购物车', 'javascript:;', class: 'btn_add_to_cart', id: 'show_inventory_cart'%>
      <% else %>
        <%= link_to '加入购物车', "/cart_items?product_id=#{@product.id}", class: 'btn_add_to_cart', method: 'post'%>
      <% end %>
      <%= link_to '立即购买', 'javascript:;', class: 'btn_buy_now', id:"show_inventory", style: 'float:right;' %>

      <input type="hidden" name="product[id]" value="<%= @product.id %>" />
      <input type="hidden" name="product[count]" value="<%= 1 %>" />
    </div>
  <% else %>
    <div class="share_buy">
    	<div class="half_left">
    		<%= image_tag @sharing_node.user.avatar_url(:thumb), class: 'share_portrait' %>
		    <dl class="share_content">
		      <dt><p><%= @sharing_node.user.identify %></p></dt>
		      <dd><%= Evaluation.sharer_good_reputation_rate(@sharing_node.user) %>好评率</dd>
		    </dl>
		  </div>
		  <div class="half_right">
	      <% if current_user %>
	        <%= link_to '加入购物车', 'javascript:;', class: 'btn_add_to_cart', id: 'show_inventory_cart'%>
	      <% else %>
	        <%= link_to '加入购物车', '/cart_items', class: 'btn_add_to_cart', method: 'post'%>
	      <% end %>
	      <%= link_to '立即购买', 'javascript:;', class: 'btn_buy_now', id:"show_inventory", style: 'float:right;' %>
		  </div>
    </div>
  <% end %>

  <%= render partial: 'new_share' %>

</div>

<div class="req-snode-modal pop-bg hidden">
  <div class="pop-content">
    <div class="alert">
      <div class="req-snode-group">
        <div class="page-title">留下手机号，现金礼品拿不停！</div>
        <p><input type="tel" name="mobile" placeholder='输入手机号，获得分享收益' class='input-block' /></p>
        <br />
        <p>
        <%= link_to "领取友情卡", get_product_sharing_path, data: { pid: @product.id },
          class: "btn btn-large btn-block req-pro-snode-btn" %>
        </p>
      </div>
      <div class="hidden">
        <p>您已成功领取，赶紧分享给朋友吧</p>
        <br />
        <a class="btn btn-large btn-block pro-snode-success-btn">确定</a>
      </div>
    </div>
  </div>
</div>

<%= simple_form_for "product_inventory", url: new_order_path(product_id: @product.id), method: 'GET' do |f| %>
  <%= hidden_field_tag "product_inventory_id" %>
  <%= hidden_field_tag "product_id", @product.id %>
  <%= hidden_field_tag "amount", 1, id:'count_amount' %>
  <div class="hidden" id="inventory">
    <div class="tab_buy_now">
      <div class="buy_now_goods">
      	<%= image_tag 'mobile/close.png',class:'btn_cancle_buy_now close',onclick:'hideBuyNow()' %>
        <img class="buy_now_goods_img" src="<%= @product.image_url() %>" alt="商品" />
        <dl class="buy_now_goods_dl">
          <dt><p><%=@product.name%></p></dt>
          <dd>
            <p>¥
              <span id="price_range"> <%= product_price(@product).join(' - ') %> </span>
            </p>
          </dd>
        </dl>
      </div>

      <div class="options" id="product_inventory_options">

      </div>
    </div>
  </div>
<% end %>

<%= hidden_field_tag "submit_way" %>

<script type="text/javascript">
  function hideBuyNow() {
    $('#inventory').addClass('hidden');
    $('.fixed-container').css('-webkit-filter', 'blur(0px)');
    $('html').removeClass('lock')
  }
</script>
