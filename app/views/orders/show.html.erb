<header class="head">
  <%= link_to account_path(@order) do %>
  <div class="bottom left iconleft"></div>
  <% end %>
  <% if @order.state == 'unpay' %>
    <div class="log_font">未付款</div>
  <% elsif @order.state == 'payed' %>
    <div class="log_font">已付款</div>
  <% elsif @order.state == 'shiped' %>
    <div class="log_font">已发货</div>
  <% elsif @order.state == 'signed' %>
    <div class="log_font">已签收</div>
  <% elsif @order.state == 'closed' %>
    <div class="log_font">交易关闭</div>
  <% end %>

</header>
<div class="container">
  <div class="subOrd_box1">
    <dl>
      <dt>
        <%= image_tag @order.order_items.first.try(:product).try(:image_url,:thumb) %>
      </dt>
      <dd>
        <strong><%= @order.order_items.first.product.name %><span>￥<%= @order.order_items.first.product.present_price %></span></strong>
        <p>规格：500g/盒</p>
        <p>大宇宙红枣公司</p>
      </dd>
    </dl>
  </div>
  <div class="subOrd_box2">
    <div class="subOrd_boxcont">
      <p class="sub_p1">
        <span class="sub_left">数量</span>
        <span class="sub_right sub_num">
          <a href="#"><%=  @order.order_items.first.try(:amount) %></a>
        </span>
      </p>
      <p class="sub_p sub_p2">
        <span class="sub_leftl">合计（含运费）</span>
        <span class="sub_left"><strong>￥</strong><%=  @order.order_items.first.try(:pay_amount) %></span>
      </p>
    </div>
    <% if @order.state == 'unpay' %>
    <div class="sub_p3">订单确认</div>
    <% end %>
  </div>
</div>
<div class="sub_box3">
  <div class="sub_box3_cont">
    <div class="sub_box3_cont1">
      <table width="100%" height="82" border="1" class="table1">
        <tr>
          <td><span>收件人：</span></td>
          <td><span>电话：</span></td>
        </tr>
        <tr>
          <td class="hidd"><%= @order.username %></td>
          <td class="hidd"><%= @order.mobile %></td>
        </tr>
        <tr>
          <td colspan="3"><span>收件地址：</span></td>
        </tr>
        <tr>
          <td colspan="3" class="hidd"><%= @order.address %></td>
        </tr>
      </table>
      <% if @order.state == 'unpay' %>
      <div class="xiugai"><span>修改订单</span></div>
      <% end %>
    </div>
  </div>
</div>

<% if @order.state == 'unpay' %>
  <div class="sub_p3">选择支付方式</div>
  <div class="weixin">
    <a href="#">
      <%= image_tag "uboss_29/weixin.png" %>
    </a>
  </div>
  <div class="zhifu">
    <a href="#"><%= image_tag "uboss_29/zhifubao.png" %></a>
  </div>

  <%= link_to order_charge_path(@order), id: 'wx-pay-btn' do %>
  <div class="accunt_adil_box3"><input type="submit" value="去支付" class="accunt_adilbtn"></div>
  <% end %>
<% end %>

<%= content_for :extra_javascript do %>
  <%= render "weixin_js" %>
<script type="text/javascript" charset="utf-8">

wx.ready(function(){

  $('#wx-pay-btn').on('click', function(event){
    event.preventDefault();
    var url = $(this).attr('href');

    $.post(url, function(data){
      wx.chooseWXPay({
        "timestamp": data.timeStamp,
        "nonceStr": data.nonceStr,
        "package": data.package,
        "signType": data.signType,
        "paySign": data.paySign,
        "success": function (res) {
          window.location.href = "/orders/" + data.order_id + "/pay_success";
        }
      });
    }).error(function(data){
      alert('支付失败');
    })

  });

  wx.onMenuShareTimeline({
    title: "<%= @order.number %>",
    link: "http://baidu.com",
    imgUrl: "http://ssobu-dev.b0.upaiyun.com/user/avatar/f2285d00cdeda94eab43d5cef15a414b.jpeg-thumb",
  });
})
</script>
<% end %>
